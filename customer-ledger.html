<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Ledger - DAWOOD AB COLLECTION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background-color: #f0f0f0;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .ledger-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .ledger-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .ledger-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .customer-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 1rem;
        }

        .info-item {
            text-align: center;
        }

        .info-item h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .info-item p {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .balance-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .balance-label {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .ledger-content {
            padding: 2rem;
        }

        .section-title {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .transactions-table th,
        .transactions-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        .transactions-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .transactions-table tr:hover {
            background: #f8f9fa;
        }

        .amount {
            font-weight: bold;
        }

        .amount.debit {
            color: #dc3545;
        }

        .amount.credit {
            color: #28a745;
        }

        .type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-badge.debit {
            background: #ffe6e6;
            color: #dc3545;
        }

        .type-badge.credit {
            background: #e6ffe6;
            color: #28a745;
        }

        .no-transactions {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .export-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin-left: 1rem;
        }

        .export-btn:hover {
            background: #f57c00;
        }

        .admin-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .add-payment-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .add-payment-btn:hover {
            background: #218838;
        }

        .add-purchase-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .add-purchase-btn:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #667eea;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-save {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .edit-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: background-color 0.3s;
        }
        .edit-btn:hover {
            background: #e0a800;
        }

        @media (max-width: 768px) {
            .ledger-header h1 {
                font-size: 2rem;
            }
            
            .customer-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .transactions-table {
                font-size: 0.9rem;
            }
            
            .transactions-table th,
            .transactions-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        @media (max-width: 600px) {
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            .main-content, .ledger-container, .ledger-header, .ledger-content {
                max-width: 100vw !important;
                box-sizing: border-box;
                word-break: break-word;
            }
            .main-content {
                padding: 1rem 0.25rem;
            }
            .ledger-header {
                padding: 1.2rem 0.5rem;
            }
            .ledger-header h1 {
                font-size: 1.5rem;
            }
            .customer-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .info-item h3 {
                font-size: 1rem;
            }
            .info-item p {
                font-size: 1.1rem;
            }
            .balance-card {
                margin-top: 0.5rem;
                padding: 1rem 0.5rem;
            }
            .balance-amount {
                font-size: 1.5rem;
            }
            .ledger-content {
                padding: 1rem 0.25rem;
            }
            .section-title {
                font-size: 1.1rem;
                padding-bottom: 0.3rem;
                margin-bottom: 1rem;
            }
            .admin-buttons {
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            .add-payment-btn, .add-purchase-btn, .export-btn {
                width: 100%;
                font-size: 1rem;
                padding: 0.75rem 0;
                margin-left: 0 !important;
            }
            .transactions-table, .transactions-table thead, .transactions-table tbody, .transactions-table th, .transactions-table td, .transactions-table tr {
                display: block;
                width: 100%;
            }
            .transactions-table thead {
                display: none;
            }
            .transactions-table tr {
                margin-bottom: 1.2rem;
                background: #fff;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                padding: 0.5rem 0.25rem;
            }
            .transactions-table td {
                padding: 0.5rem 0.5rem;
                text-align: left;
                position: relative;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            .transactions-table td:before {
                content: attr(data-label);
                font-weight: bold;
                color: #667eea;
                display: block;
                margin-bottom: 0.2rem;
                font-size: 0.95em;
            }
            .no-transactions {
                padding: 2rem 0.5rem;
                font-size: 1rem;
            }
            .modal-content {
                width: 98vw;
                max-width: 99vw;
                min-width: 0;
                margin: 8vw auto;
                padding: 1rem 0.5rem;
                border-radius: 10px;
                box-sizing: border-box;
                max-height: 90vh;
                overflow-y: auto;
            }
            .modal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .modal-title {
                font-size: 1.1rem;
            }
            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            .modal-buttons {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            .btn-cancel, .btn-save {
                width: 100%;
                font-size: 1rem;
                padding: 0.75rem 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="index.html" class="logo">DAWOOD AB COLLECTION</a>
            <div class="nav-links">
                <a href="owner-login.html">Owner Login</a>
                <a href="owner-dashboard.html" class="logout-btn">Back to Dashboard</a>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <a href="owner-dashboard.html" id="backToListBtn" class="btn" style="background: #007bff; color: white; margin-bottom: 1.5rem; display: inline-block;">← Back to List</a>
        <div class="ledger-container">
            <div class="ledger-header">
                <h1>My Ledger</h1>
                <div class="customer-info">
                    <div class="info-item">
                        <h3>Customer Name <button id="editCustomerInfoBtn" title="Edit Name/City" style="background:none;border:none;cursor:pointer;font-size:1.1em;color:#007bff;margin-left:0.5em;vertical-align:middle;">✏️</button></h3>
                        <p id="customerName">Loading...</p>
                    </div>
                    <div class="info-item">
                        <h3>Phone Number</h3>
                        <p id="customerPhone">Loading...</p>
                    </div>
                    <div class="info-item">
                        <h3>City</h3>
                        <p id="customerCity">Loading...</p>
                    </div>
                </div>
                <div class="balance-card">
                    <div class="balance-amount" id="currentBalance">Loading...</div>
                    <div class="balance-label">Current Balance</div>
                </div>
            </div>

            <div class="ledger-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">Transaction History</h2>
                    <button class="export-btn" onclick="exportCustomerLedgerAsImage()">Save as JPG</button>
                </div>
                
                <!-- Admin Buttons (only visible if owner is logged in) -->
                <div class="admin-buttons" id="adminButtons" style="display: none;">
                    <button class="add-payment-btn" onclick="showAddPaymentModal()">Add Payment</button>
                    <button class="add-purchase-btn" onclick="showAddPurchaseModal()">Add Purchase</button>
                </div>
                
                <div id="transactionsContainer">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Amount (PKR)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="4" class="no-transactions">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Payment</h2>
                <span class="close" onclick="closeAddPaymentModal()">&times;</span>
            </div>
            
            <div class="success-message" id="paymentSuccessMessage">
                Payment added successfully!
            </div>
            
            <form id="addPaymentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentDate">Date</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Amount (PKR)</label>
                        <input type="number" id="paymentAmount" min="1" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paymentDescription">Description</label>
                    <textarea id="paymentDescription" placeholder="Enter payment description (e.g., Cash Payment, Bank Transfer, etc.)" required></textarea>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeAddPaymentModal()">Cancel</button>
                    <button type="submit" class="btn-save">Add Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Purchase Modal -->
    <div id="addPurchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Purchase</h2>
                <span class="close" onclick="closeAddPurchaseModal()">&times;</span>
            </div>
            
            <div class="success-message" id="purchaseSuccessMessage">
                Purchase added successfully!
            </div>
            
            <form id="addPurchaseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="purchaseDate">Date</label>
                        <input type="date" id="purchaseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="purchaseAmount">Amount (PKR)</label>
                        <input type="number" id="purchaseAmount" min="1" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="purchaseDescription">Description</label>
                    <textarea id="purchaseDescription" placeholder="Enter purchase description (e.g., Fabric Purchase - Lawn, Silk Material, etc.)" required></textarea>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeAddPurchaseModal()">Cancel</button>
                    <button type="submit" class="btn-save">Add Purchase</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Customer Info Modal -->
    <div id="editCustomerInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Customer Info</h2>
                <span class="close" onclick="closeEditCustomerInfoModal()">&times;</span>
            </div>
            <form id="editCustomerInfoForm">
                <div class="form-group">
                    <label for="editCustomerName">Name</label>
                    <input type="text" id="editCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="editCustomerCity">City</label>
                    <input type="text" id="editCustomerCity" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeEditCustomerInfoModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Transaction</h2>
                <span class="close" onclick="closeEditTransactionModal()">&times;</span>
            </div>
            <form id="editTransactionForm">
                <div class="form-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" required>
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <input type="text" id="editDescription" required>
                </div>
                <div class="form-group">
                    <label for="editAmount">Amount (PKR)</label>
                    <input type="number" id="editAmount" required style="border: 2px solid #ffc107; background: #fffbe6;">
                </div>
                <div class="form-group">
                    <label for="editType">Type</label>
                    <select id="editType" required>
                        <option value="debit">Purchase</option>
                        <option value="credit">Payment</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeEditTransactionModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Get current customer phone from sessionStorage
        const sessionCustomer = sessionStorage.getItem('currentCustomer');
        let customer = null;
        let customers = {};
        if (localStorage.getItem('dawood_ab_collection_customers')) {
            try {
                customers = JSON.parse(localStorage.getItem('dawood_ab_collection_customers'));
            } catch (e) {
                customers = {};
            }
        }
        let customerPhone = null;
        if (sessionCustomer) {
            try {
                const parsed = JSON.parse(sessionCustomer);
                customerPhone = parsed.phone;
            } catch (e) {}
        }
        if (!customerPhone || !customers[customerPhone]) {
            window.location.href = 'owner-dashboard.html';
        } else {
            customer = customers[customerPhone];
            // Update sessionStorage with the latest customer data
            sessionStorage.setItem('currentCustomer', JSON.stringify(customer));
        }

        // Check if owner is logged in to show admin buttons and back to list
        const ownerLoggedIn = sessionStorage.getItem('ownerLoggedIn');
        if (ownerLoggedIn) {
            document.getElementById('adminButtons').style.display = 'flex';
            document.getElementById('backToListBtn').style.display = 'inline-block';
        } else {
            // Hide admin buttons, modals, and back to list for customers
            document.getElementById('adminButtons').style.display = 'none';
            document.getElementById('backToListBtn').style.display = 'none';
            const paymentModal = document.getElementById('addPaymentModal');
            if (paymentModal) paymentModal.remove();
            const purchaseModal = document.getElementById('addPurchaseModal');
            if (purchaseModal) purchaseModal.remove();
        }
        
        // Populate customer information
        document.getElementById('customerName').textContent = customer.name;
        document.getElementById('customerPhone').textContent = customer.phone;
        document.getElementById('customerCity').textContent = customer.city ? customer.city : 'Not set';
        
        // Format and display balance
        const balance = customer.balance;
        const balanceElement = document.getElementById('currentBalance');
        if (balance >= 0) {
            balanceElement.textContent = `PKR ${balance.toLocaleString()}`;
            balanceElement.style.color = '#28a745';
        } else {
            balanceElement.textContent = `PKR ${Math.abs(balance).toLocaleString()}`;
            balanceElement.style.color = '#dc3545';
        }
        
        // Populate transactions table
        const tableBody = document.getElementById('transactionsTableBody');
        
        if (customer.transactions && customer.transactions.length > 0) {
            tableBody.innerHTML = '';
            
            customer.transactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                
                const date = transaction.date;
                const amount = transaction.amount.toLocaleString();
                const typeClass = transaction.type === 'debit' ? 'debit' : 'credit';
                const typeText = transaction.type === 'debit' ? 'Purchase' : 'Payment';
                
                row.innerHTML = `
                    <td data-label="Date">${date}</td>
                    <td data-label="Description">${transaction.description}</td>
                    <td data-label="Type"><span class="type-badge ${typeClass}">${typeText}</span></td>
                    <td data-label="Amount (PKR)" class="amount ${typeClass}">PKR ${amount}</td>
                    <td data-label="Actions"><button class="edit-btn" onclick="showEditTransactionModal(${index})">Edit</button></td>
                `;
                
                tableBody.appendChild(row);
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="4" class="no-transactions">No transactions found</td></tr>';
        }

        // Modal functions for adding payments and purchases
        function showAddPaymentModal() {
            const modal = document.getElementById('addPaymentModal');
            const paymentDate = document.getElementById('paymentDate');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            paymentDate.value = today;
            
            // Show modal
            modal.style.display = 'block';
            
            // Hide success message if visible
            document.getElementById('paymentSuccessMessage').style.display = 'none';
        }

        function closeAddPaymentModal() {
            const modal = document.getElementById('addPaymentModal');
            modal.style.display = 'none';
            
            // Reset form
            document.getElementById('addPaymentForm').reset();
        }

        function showAddPurchaseModal() {
            const modal = document.getElementById('addPurchaseModal');
            const purchaseDate = document.getElementById('purchaseDate');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            purchaseDate.value = today;
            
            // Show modal
            modal.style.display = 'block';
            
            // Hide success message if visible
            document.getElementById('purchaseSuccessMessage').style.display = 'none';
        }

        function closeAddPurchaseModal() {
            const modal = document.getElementById('addPurchaseModal');
            modal.style.display = 'none';
            
            // Reset form
            document.getElementById('addPurchaseForm').reset();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const paymentModal = document.getElementById('addPaymentModal');
            const purchaseModal = document.getElementById('addPurchaseModal');
            const editCustomerInfoModal = document.getElementById('editCustomerInfoModal');
            
            if (event.target === paymentModal) {
                closeAddPaymentModal();
            }
            if (event.target === purchaseModal) {
                closeAddPurchaseModal();
            }
            if (event.target === editCustomerInfoModal) {
                closeEditCustomerInfoModal();
            }
        }

        // Handle payment form submission
        document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDescription = document.getElementById('paymentDescription').value;
            
            if (!paymentDate || !paymentAmount || !paymentDescription) {
                alert('Please fill in all fields');
                return;
            }
            
            // Add payment to customer
            customer.transactions.unshift({
                date: paymentDate,
                description: paymentDescription,
                amount: paymentAmount,
                type: 'credit'
            });
            
            // Update customer balance (payment reduces balance)
            customer.balance -= paymentAmount;
            
            // Save to localStorage and sessionStorage
            customers[customerPhone] = customer;
            localStorage.setItem('dawood_ab_collection_customers', JSON.stringify(customers));
            sessionStorage.setItem('currentCustomer', JSON.stringify(customer));
            
            // Refresh the page to show updated data
            location.reload();
        });

        // Handle purchase form submission
        document.getElementById('addPurchaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const purchaseDate = document.getElementById('purchaseDate').value;
            const purchaseAmount = parseFloat(document.getElementById('purchaseAmount').value);
            const purchaseDescription = document.getElementById('purchaseDescription').value;
            
            if (!purchaseDate || !purchaseAmount || !purchaseDescription) {
                alert('Please fill in all fields');
                return;
            }
            
            // Add purchase to customer
            customer.transactions.unshift({
                date: purchaseDate,
                description: purchaseDescription,
                amount: purchaseAmount,
                type: 'debit'
            });
            
            // Update customer balance (purchase increases balance)
            customer.balance += purchaseAmount;
            
            // Save to localStorage and sessionStorage
            customers[customerPhone] = customer;
            localStorage.setItem('dawood_ab_collection_customers', JSON.stringify(customers));
            sessionStorage.setItem('currentCustomer', JSON.stringify(customer));
            
            // Refresh the page to show updated data
            location.reload();
        });

        let editTransactionIndex = null;
        let originalAmount = 0;
        let originalType = '';

        function showEditTransactionModal(index) {
            editTransactionIndex = index;
            const transaction = customer.transactions[index];
            document.getElementById('editDate').value = transaction.date;
            document.getElementById('editDescription').value = transaction.description;
            document.getElementById('editAmount').value = transaction.amount;
            document.getElementById('editType').value = transaction.type;
            originalAmount = transaction.amount;
            originalType = transaction.type;
            document.getElementById('editTransactionModal').style.display = 'block';
        }

        function closeEditTransactionModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
            editTransactionIndex = null;
        }

        document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (editTransactionIndex === null) return;

            // Get new values
            const newDate = document.getElementById('editDate').value;
            const newDescription = document.getElementById('editDescription').value;
            const newAmount = parseFloat(document.getElementById('editAmount').value);
            const newType = document.getElementById('editType').value;

            // Adjust balance: remove old, add new
            if (originalType === 'debit') {
                customer.balance -= originalAmount;
            } else {
                customer.balance += originalAmount;
            }
            if (newType === 'debit') {
                customer.balance += newAmount;
            } else {
                customer.balance -= newAmount;
            }

            // Update transaction
            customer.transactions[editTransactionIndex] = {
                date: newDate,
                description: newDescription,
                amount: newAmount,
                type: newType
            };

            // Save changes
            customers[customerPhone] = customer;
            localStorage.setItem('dawood_ab_collection_customers', JSON.stringify(customers));
            sessionStorage.setItem('currentCustomer', JSON.stringify(customer));

            // Refresh page to update UI
            location.reload();

            closeEditTransactionModal();
        });

        // Edit Customer Info Modal logic
        document.getElementById('editCustomerInfoBtn').onclick = function() {
            document.getElementById('editCustomerName').value = customer.name;
            document.getElementById('editCustomerCity').value = customer.city ? customer.city : '';
            document.getElementById('editCustomerInfoModal').style.display = 'block';
        };
        function closeEditCustomerInfoModal() {
            document.getElementById('editCustomerInfoModal').style.display = 'none';
        }
        document.getElementById('editCustomerInfoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newName = document.getElementById('editCustomerName').value.trim();
            const newCity = document.getElementById('editCustomerCity').value.trim();
            if (!newName || !newCity) {
                alert('Please fill in both name and city.');
                return;
            }
            customer.name = newName;
            customer.city = newCity;
            customers[customerPhone] = customer;
            localStorage.setItem('dawood_ab_collection_customers', JSON.stringify(customers));
            sessionStorage.setItem('currentCustomer', JSON.stringify(customer));
            document.getElementById('customerName').textContent = newName;
            document.getElementById('customerCity').textContent = newCity;
            closeEditCustomerInfoModal();
        });
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editCustomerInfoModal');
            if (event.target === editModal) {
                closeEditCustomerInfoModal();
            }
        });

        // Export customer ledger as JPG image
        function exportCustomerLedgerAsImage() {
            const customerData = sessionStorage.getItem('currentCustomer');
            if (!customerData) return;
            
            const customer = JSON.parse(customerData);
            
            // Create a canvas element
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate canvas height based on number of transactions
            const baseHeight = 600;
            const transactionHeight = customer.transactions.length * 30;
            const canvasHeight = Math.max(baseHeight, transactionHeight + 400);
            
            // Set canvas size
            canvas.width = 1000;
            canvas.height = canvasHeight;
            
            // Set background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add header
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, canvas.width, 120);
            
            // Add title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('DAWOOD AB COLLECTION - CUSTOMER LEDGER', canvas.width / 2, 35);
            
            ctx.font = '16px Arial';
            ctx.fillText(`Generated on: ${new Date().toLocaleDateString('en-PK')}`, canvas.width / 2, 60);
            
            // Add customer information
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Customer Information:', 50, 160);
            
            ctx.font = '16px Arial';
            ctx.fillText(`Name: ${customer.name}`, 50, 190);
            ctx.fillText(`Phone: ${customer.phone}`, 50, 215);
            
            // Add current balance
            const balanceColor = customer.balance >= 0 ? '#28a745' : '#dc3545';
            ctx.fillStyle = balanceColor;
            ctx.font = 'bold 18px Arial';
            ctx.fillText(`Current Balance: PKR ${customer.balance.toLocaleString()}`, 50, 250);
            
            // Add transaction table header
            ctx.fillStyle = '#667eea';
            ctx.fillRect(50, 280, canvas.width - 100, 40);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Date', 70, 305);
            ctx.fillText('Description', 200, 305);
            ctx.fillText('Type', 500, 305);
            ctx.fillText('Amount (PKR)', 650, 305);
            
            // Add transaction data
            let yPosition = 340;
            ctx.fillStyle = '#333333';
            ctx.font = '14px Arial';
            
            customer.transactions.forEach((transaction, index) => {
                // Alternate row colors
                if (index % 2 === 0) {
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(50, yPosition - 20, canvas.width - 100, 30);
                }
                
                const date = new Date(transaction.date).toLocaleDateString('en-PK');
                const amount = transaction.amount.toLocaleString();
                const typeText = transaction.type === 'debit' ? 'Purchase' : 'Payment';
                const typeColor = transaction.type === 'debit' ? '#dc3545' : '#28a745';
                
                ctx.fillStyle = '#333333';
                ctx.fillText(date, 70, yPosition);
                ctx.fillText(transaction.description, 200, yPosition);
                
                ctx.fillStyle = typeColor;
                ctx.fillText(typeText, 500, yPosition);
                ctx.fillText(`PKR ${amount}`, 650, yPosition);
                
                yPosition += 35;
            });
            
            // Add footer
            ctx.fillStyle = '#666666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('DAWOOD AB COLLECTION - Premium Unstitched Fabric Store', canvas.width / 2, canvasHeight - 20);
            
            // Convert canvas to blob and download
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${customer.name.replace(/\s+/g, '_')}_LEDGER_${new Date().toISOString().split('T')[0]}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/jpeg', 0.9);
        }
    </script>
</body>
</html> 